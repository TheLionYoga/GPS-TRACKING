<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pencatat Koordinat</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      height: 100%;
    }
    
    html {
      height: 100%;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .header h1 {
      margin: 0 0 16px 0;
      font-size: 28px;
      font-weight: 700;
      color: #1a202c;
    }
    
    .map-container {
      width: 100%;
      height: 200px;
      background: #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      margin-bottom: 16px;
    }
    
    #map {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 14px;
    }
    
    .location-info {
      background: #f8fafc;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      color: #475569;
    }
    
    .location-info strong {
      color: #1e293b;
    }
    
    .save-section, .location-section, .saved-coordinates {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .save-form {
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
      background: white;
    }
    
    .form-select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      font-weight: normal;
      color: #374151;
      cursor: pointer;
      margin-bottom: 0;
    }
    
    .checkbox-label input[type="checkbox"] {
      margin-right: 6px;
      width: auto;
      padding: 0;
    }
    
    .save-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      width: 100%;
    }
    
    .save-btn:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .save-btn:active {
      transform: translateY(0);
    }
    
    .save-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .location-details {
      background: #f8fafc;
      padding: 16px;
      border-radius: 12px;
    }
    
    .location-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .location-row:last-child {
      border-bottom: none;
    }
    
    .location-label {
      font-weight: 600;
      color: #475569;
    }
    
    .location-value {
      font-family: 'Courier New', monospace;
      color: #1e293b;
      font-weight: 500;
    }
    
    .coordinates-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .coordinate-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s ease;
    }
    
    .coordinate-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    
    .coordinate-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .coordinate-time {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .coordinate-note {
      font-size: 16px;
      color: #1f2937;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .coordinate-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .coordinate-detail {
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .coordinate-detail-label {
      color: #6b7280;
      font-weight: 500;
    }
    
    .coordinate-detail-value {
      color: #1f2937;
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }
    
    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .delete-btn:hover:not(:disabled) {
      background: #dc2626;
    }
    
    .delete-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    .maps-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
    }
    
    .maps-btn:hover:not(:disabled) {
      background: #3367d6;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
    }
    
    .maps-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1e293b;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    
    .gps-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #f59e0b;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      z-index: 1001;
      animation: slideDown 0.3s ease;
      max-width: 90%;
      text-align: center;
      font-weight: 600;
    }
    
    .gps-notification.error {
      background: #ef4444;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .gps-notification.success {
      background: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
    
    @media (max-width: 640px) {
      .container {
        padding: 12px;
      }
      
      .header, .save-section, .location-section, .saved-coordinates {
        padding: 16px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .coordinate-details {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <div class="header">
    <h1 id="appTitle">Pencatat Koordinat</h1>
    <div class="map-container">
     <div id="map">
      üìç Menunggu lokasi...
     </div>
    </div>
    <div class="location-info" id="locationInfo"><strong>Lokasi Saat Ini:</strong> Memuat...
    </div>
    <div class="offline-tips" id="offlineTips" style="display: none;">
     <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 12px;"><strong>üí° Tips GPS Offline:</strong><br>
       ‚Ä¢ Pastikan berada di area terbuka (tidak di dalam gedung)<br>
       ‚Ä¢ Tunggu 1-3 menit untuk sinyal satelit GPS<br>
       ‚Ä¢ Hindari area dengan banyak gedung tinggi<br>
       ‚Ä¢ GPS offline lebih akurat di siang hari
     </div>
    </div>
   </div>
   <div class="location-section">
    <h2 id="locationTitle">Informasi Lokasi Realtime</h2>
    <div class="location-details" id="locationDetails">
     <div class="location-row"><span class="location-label">üìç Latitude:</span> <span class="location-value" id="latValue">-</span>
     </div>
     <div class="location-row"><span class="location-label">üìç Longitude:</span> <span class="location-value" id="lngValue">-</span>
     </div>
     <div class="location-row"><span class="location-label">üéØ Akurasi:</span> <span class="location-value" id="accuracyValue">-</span>
     </div>
     <div class="location-row"><span class="location-label">üïí Update:</span> <span class="location-value" id="timeValue">-</span>
     </div>
     <div class="location-row"><span class="location-label">üó∫Ô∏è Maps:</span> <button id="openMapsBtn" class="maps-btn" onclick="openGoogleMaps()">Buka di Google Maps</button>
     </div>
    </div>
   </div>
   <div class="save-section">
    <h2 id="saveTitle">Simpan Koordinat</h2>
    <div class="save-form">
     <div class="form-group"><label for="kecamatanSelect">üèõÔ∏è Kecamatan:</label> <select id="kecamatanSelect" class="form-select"> <option value="">Pilih Kecamatan</option> <option value="BELIMBING">BELIMBING</option> <option value="BELIMBING HULU">BELIMBING HULU</option> <option value="ELLA HILIR">ELLA HILIR</option> <option value="MENUKUNG">MENUKUNG</option> <option value="NANGA PINOH">NANGA PINOH</option> <option value="PINOH SELATAN">PINOH SELATAN</option> <option value="PINOH UTARA">PINOH UTARA</option> <option value="SAYAN">SAYAN</option> <option value="SOKAN">SOKAN</option> <option value="TANAH PINOH">TANAH PINOH</option> <option value="TANAH PINOH BARAT">TANAH PINOH BARAT</option> <option value="lainnya">Lainnya</option> </select> <input type="text" id="kecamatanCustom" placeholder="Masukkan nama kecamatan..." style="display: none; margin-top: 8px;" class="form-input">
     </div>
     <div class="form-group"><label for="desaSelect">üèòÔ∏è Desa:</label> <select id="desaSelect" class="form-select"> <option value="">Pilih Desa</option> <option value="LANGAN">LANGAN</option> <option value="NANGA PAU">NANGA PAU</option> <option value="NANGA ENTEBAH">NANGA ENTEBAH</option> <option value="KAYU BUNGA">KAYU BUNGA</option> <option value="NANGA KALAN">NANGA KALAN</option> <option value="PEREMBANG NYURUH">PEREMBANG NYURUH</option> <option value="KERANGAN KORA">KERANGAN KORA</option> <option value="NANGA NYURUH">NANGA NYURUH</option> <option value="KAHIYA">KAHIYA</option> <option value="BEMBAN PERMAI">BEMBAN PERMAI</option> <option value="SUNGAI LABUK">SUNGAI LABUK</option> <option value="TANJUNG BERINGIN">TANJUNG BERINGIN</option> <option value="SAMPAK">SAMPAK</option> <option value="PELAIK KERUAP">PELAIK KERUAP</option> <option value="BATU ONAP">BATU ONAP</option> <option value="BELABAN ELLA">BELABAN ELLA</option> <option value="NANGA KAYAN">NANGA KAYAN</option> <option value="PAAL">PAAL</option> <option value="PELINGGANG">PELINGGANG</option> <option value="BINA JAYA">BINA JAYA</option> <option value="NYANGGAI">NYANGGAI</option> <option value="SENEMPAK">SENEMPAK</option> <option value="MANDAU BARU">MANDAU BARU</option> <option value="NANGA KELAWAI">NANGA KELAWAI</option> <option value="LANDAU GARONG">LANDAU GARONG</option> <option value="SUNGAI BAKAH">SUNGAI BAKAH</option> <option value="KAYAN SEMAPAU">KAYAN SEMAPAU</option> <option value="BEROBAI PERMAI">BEROBAI PERMAI</option> <option value="BORA">BORA</option> <option value="MEKAR PELITA">MEKAR PELITA</option> <option value="META BERSATU">META BERSATU</option> <option value="SILING PERMAI">SILING PERMAI</option> <option value="TUMBAK RAYA">TUMBAK RAYA</option> <option value="NANGA RAKU">NANGA RAKU</option> <option value="PEKAWAI">PEKAWAI</option> <option value="NANGA KOMPI">NANGA KOMPI</option> <option value="NANGA PAK">NANGA PAK</option> <option value="KARANGAN PURUN">KARANGAN PURUN</option> <option value="LANDAU SANDAK">LANDAU SANDAK</option> <option value="NANGA MANCUR">NANGA MANCUR</option> <option value="TANJUNG MAHUNG">TANJUNG MAHUNG</option> <option value="NANGA POTAI">NANGA POTAI</option> <option value="NANGA ORA">NANGA ORA</option> <option value="PENYENGKUANG">PENYENGKUANG</option> <option value="TELAGA RAYA">TELAGA RAYA</option> <option value="NANGA LIBAS">NANGA LIBAS</option> <option value="TELUK PONGKAL">TELUK PONGKAL</option> <option value="SIJAU">SIJAU</option> <option value="NANGA BETANGAI">NANGA BETANGAI</option> <option value="KELUING TAJA">KELUING TAJA</option> <option value="MARIS PERMAI">MARIS PERMAI</option> <option value="HARAPAN JAYA">HARAPAN JAYA</option> <option value="KELUAS HULU">KELUAS HULU</option> <option value="LAJA">LAJA</option> <option value="BUKIT RAYA">BUKIT RAYA</option> <option value="LINTAH TAUM">LINTAH TAUM</option> <option value="TOGAN BARU">TOGAN BARU</option> <option value="GANJANG">GANJANG</option> <option value="DURIAN JAYA">DURIAN JAYA</option> <option value="PELITA JAYA">PELITA JAYA</option> <option value="ULAK MUID">ULAK MUID</option> <option value="lainnya">Lainnya</option> </select> <input type="text" id="desaCustom" placeholder="Masukkan nama desa..." style="display: none; margin-top: 8px;" class="form-input">
     </div>
     <div class="form-group"><label for="pendidikanSelect">üéì Layanan Pendidikan:</label> <select id="pendidikanSelect" class="form-select"> <option value="">Pilih Layanan Pendidikan</option> <option value="SD">SD</option> <option value="SMP">SMP</option> <option value="SMA">SMA</option> <option value="SMK">SMK</option> <option value="SLB">SLB</option> <option value="lainnya">Lainnya</option> </select> <input type="text" id="pendidikanCustom" placeholder="Masukkan layanan pendidikan..." style="display: none; margin-top: 8px;" class="form-input"> <input type="text" id="namaLayananPendidikan" placeholder="Nama layanan pendidikan..." class="form-input" style="margin-top: 8px;">
     </div>
     <div class="form-group"><label for="kesehatanSelect">üè• Layanan Kesehatan:</label> <select id="kesehatanSelect" class="form-select"> <option value="">Pilih Layanan Kesehatan</option> <option value="Pustu">Pustu</option> <option value="Puskesmas">Puskesmas</option> <option value="lainnya">Lainnya</option> </select> <input type="text" id="kesehatanCustom" placeholder="Masukkan layanan kesehatan..." style="display: none; margin-top: 8px;" class="form-input"> <input type="text" id="namaLayananKesehatan" placeholder="Nama layanan kesehatan..." class="form-input" style="margin-top: 8px;">
     </div>
     <div class="form-group"><label for="sinyalSelect">üì∂ Sinyal Telekomunikasi:</label> <select id="sinyalSelect" class="form-select"> <option value="">Pilih Sinyal</option> <option value="Tidak Ada Sinyal">Tidak Ada Sinyal</option> <option value="2G">2G</option> <option value="3G">3G</option> <option value="4G">4G</option> </select>
     </div>
     <div class="form-group"><label for="plnSelect">‚ö° Akses PLN:</label> <select id="plnSelect" class="form-select"> <option value="">Pilih Status</option> <option value="Ada">Ada</option> <option value="Tidak Ada">Tidak Ada</option> </select>
     </div>
     <div class="form-group"><label for="jangkauanSelect">üì° Jangkauan Sinyal:</label> <select id="jangkauanSelect" class="form-select"> <option value="">Pilih Jangkauan</option> <option value="Sebagian">Sebagian</option> <option value="Seluruh Wilayah Desa">Seluruh Wilayah Desa</option> </select>
     </div><button class="save-btn" id="saveBtn">üìç Simpan Koordinat</button>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Pencatat Koordinat",
      save_button_text: "Simpan Koordinat",
      empty_message: "Belum ada koordinat yang disimpan",
      location_title: "Informasi Lokasi Realtime",
      primary_color: "#10b981",
      background_gradient_start: "#667eea",
      background_gradient_end: "#764ba2",
      text_color: "#1a202c",
      font_family: "Inter",
      font_size: 16
    };
    
    let currentLocation = null;
    let locationWatchId = null;
    let savedCoordinates = [];
    
    const dataHandler = {
      onDataChanged(data) {
        savedCoordinates = data;
      }
    };
    
    async function onConfigChange(config) {
      const appTitle = config.app_title || defaultConfig.app_title;
      const saveButtonText = config.save_button_text || defaultConfig.save_button_text;
      const emptyMessage = config.empty_message || defaultConfig.empty_message;
      const locationTitle = config.location_title || defaultConfig.location_title;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const bgStart = config.background_gradient_start || defaultConfig.background_gradient_start;
      const bgEnd = config.background_gradient_end || defaultConfig.background_gradient_end;
      const textColor = config.text_color || defaultConfig.text_color;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;
      
      document.getElementById('appTitle').textContent = appTitle;
      document.getElementById('saveBtn').innerHTML = `üìç ${saveButtonText}`;
      document.getElementById('emptyMessage').textContent = emptyMessage;
      document.getElementById('locationTitle').textContent = locationTitle;
      
      document.body.style.background = `linear-gradient(135deg, ${bgStart} 0%, ${bgEnd} 100%)`;
      document.body.style.fontFamily = `'${fontFamily}', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
      
      document.getElementById('saveBtn').style.background = primaryColor;
      
      const headers = document.querySelectorAll('h1, h2');
      headers.forEach(h => {
        h.style.color = textColor;
        if (h.tagName === 'H1') {
          h.style.fontSize = `${fontSize * 1.75}px`;
        } else {
          h.style.fontSize = `${fontSize * 1.375}px`;
        }
      });
      
      document.body.style.fontSize = `${fontSize}px`;
    }
    
    function showToast(message) {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    function showGPSNotification(message, type = 'warning') {
      const existingNotification = document.querySelector('.gps-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = `gps-notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Auto remove after 5 seconds for warnings, 3 seconds for success
      const timeout = type === 'warning' ? 5000 : 3000;
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, timeout);
    }
    
    function updateLocationDisplay() {
      const locationInfo = document.getElementById('locationInfo');
      const mapDiv = document.getElementById('map');
      const latValue = document.getElementById('latValue');
      const lngValue = document.getElementById('lngValue');
      const accuracyValue = document.getElementById('accuracyValue');
      const timeValue = document.getElementById('timeValue');
      const mapsBtn = document.getElementById('openMapsBtn');
      
      if (currentLocation) {
        const offlineStatus = currentLocation.isOffline ? ' üì° (Mode Offline)' : ' üåê (Online)';
        locationInfo.innerHTML = `<strong>Lokasi Saat Ini:</strong> ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}${offlineStatus}`;
        
        const mapStatus = currentLocation.isOffline ? 'üì° GPS Murni' : 'üåê GPS + Internet';
        mapDiv.innerHTML = `üìç Lat: ${currentLocation.latitude.toFixed(4)}, Lng: ${currentLocation.longitude.toFixed(4)} | ${mapStatus}`;
        
        latValue.textContent = currentLocation.latitude.toFixed(8);
        lngValue.textContent = currentLocation.longitude.toFixed(8);
        accuracyValue.textContent = currentLocation.accuracy ? `¬±${currentLocation.accuracy.toFixed(0)}m` : 'N/A';
        timeValue.textContent = new Date().toLocaleTimeString('id-ID');
        
        // Enable maps button (works offline too, will open when internet available)
        mapsBtn.disabled = false;
        if (currentLocation.isOffline) {
          mapsBtn.textContent = 'Buka Maps (Butuh Internet)';
        } else {
          mapsBtn.textContent = 'Buka di Google Maps';
        }
      } else {
        const connectionStatus = checkInternetConnection() ? 'Online' : 'Offline';
        locationInfo.innerHTML = `<strong>Lokasi Saat Ini:</strong> Tidak tersedia (${connectionStatus})`;
        mapDiv.innerHTML = `üìç Mencari lokasi... (${connectionStatus})`;
        
        latValue.textContent = '-';
        lngValue.textContent = '-';
        accuracyValue.textContent = '-';
        timeValue.textContent = '-';
        
        // Disable maps button
        mapsBtn.disabled = true;
        mapsBtn.textContent = 'Lokasi tidak tersedia';
      }
    }
    
    function openGoogleMaps() {
      if (!currentLocation) {
        showToast('Lokasi belum terdeteksi');
        return;
      }
      
      const lat = currentLocation.latitude;
      const lng = currentLocation.longitude;
      const mapsUrl = `https://www.google.com/maps?q=${lat},${lng}&z=15`;
      
      // Open in new tab
      window.open(mapsUrl, '_blank', 'noopener,noreferrer');
      showToast('üó∫Ô∏è Membuka Google Maps...');
    }
    
    function checkInternetConnection() {
      return navigator.onLine;
    }
    
    function startLocationWatch() {
      if ('geolocation' in navigator) {
        const isOnline = checkInternetConnection();
        
        if (isOnline) {
          showGPSNotification('üìç Mencari lokasi GPS dengan bantuan internet...', 'warning');
        } else {
          showGPSNotification('üì° Mode Offline: Mencari lokasi GPS murni (tanpa internet). Proses mungkin lebih lama...', 'warning');
        }
        
        // Konfigurasi GPS untuk mode offline
        const gpsOptions = {
          enableHighAccuracy: true,
          maximumAge: isOnline ? 1000 : 30000, // Cache lebih lama jika offline
          timeout: isOnline ? 15000 : 60000    // Timeout lebih lama jika offline
        };
        
        locationWatchId = navigator.geolocation.watchPosition(
          (position) => {
            // First time getting location - show success notification
            if (!currentLocation) {
              const connectionStatus = checkInternetConnection() ? 'dengan internet' : 'tanpa internet (GPS murni)';
              showGPSNotification(`‚úÖ GPS berhasil diaktifkan ${connectionStatus}!`, 'success');
            }
            
            currentLocation = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
              accuracy: position.coords.accuracy,
              isOffline: !checkInternetConnection()
            };
            updateLocationDisplay();
          },
          (error) => {
            console.error('Error getting location:', error);
            
            let errorMessage = '';
            const isOffline = !checkInternetConnection();
            
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = 'üö´ Akses lokasi ditolak. Silakan aktifkan GPS dan izinkan akses lokasi.';
                break;
              case error.POSITION_UNAVAILABLE:
                if (isOffline) {
                  errorMessage = 'üì° GPS tidak dapat menemukan lokasi. Pastikan Anda berada di area terbuka dan tunggu lebih lama untuk sinyal satelit.';
                } else {
                  errorMessage = 'üìç Lokasi tidak tersedia. Pastikan GPS aktif dan Anda berada di area terbuka.';
                }
                break;
              case error.TIMEOUT:
                if (isOffline) {
                  errorMessage = '‚è±Ô∏è GPS membutuhkan waktu lebih lama tanpa internet. Tetap di area terbuka dan tunggu...';
                } else {
                  errorMessage = '‚è±Ô∏è Timeout mencari lokasi. Coba refresh halaman dan pastikan GPS aktif.';
                }
                break;
              default:
                errorMessage = isOffline ? 
                  '‚ùå GPS tidak dapat mengunci lokasi. Pastikan berada di area terbuka tanpa penghalang.' :
                  '‚ùå Tidak dapat mengakses lokasi. Pastikan GPS aktif.';
                break;
            }
            
            showGPSNotification(errorMessage, 'error');
            showToast('Tidak dapat mengakses lokasi');
          },
          gpsOptions
        );
        
        // Monitor perubahan koneksi internet
        window.addEventListener('online', () => {
          showGPSNotification('üåê Internet tersambung kembali - GPS akan lebih cepat', 'success');
        });
        
        window.addEventListener('offline', () => {
          showGPSNotification('üì° Mode Offline: GPS akan menggunakan sinyal satelit murni', 'warning');
          // Show offline tips
          const offlineTips = document.getElementById('offlineTips');
          if (offlineTips) {
            offlineTips.style.display = 'block';
          }
        });
        
        window.addEventListener('online', () => {
          // Hide offline tips when back online
          const offlineTips = document.getElementById('offlineTips');
          if (offlineTips) {
            offlineTips.style.display = 'none';
          }
        });
        
        // Show tips immediately if already offline
        if (!checkInternetConnection()) {
          const offlineTips = document.getElementById('offlineTips');
          if (offlineTips) {
            offlineTips.style.display = 'block';
          }
        }
        
      } else {
        showGPSNotification('‚ùå Perangkat tidak mendukung GPS', 'error');
        showToast('Geolocation tidak didukung');
      }
    }
    
    function stopLocationWatch() {
      if (locationWatchId) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
      }
    }
    
    // Google Apps Script URL - Ganti dengan URL Web App Anda
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxepvn4dywGjFYlCm0xRQ9ViqSQi8IYw3ARikOyoeC_Vd3TIIaXhHH4_MWDH2ToKWtA/exec';
    
    async function sendToGoogleSheets(data) {
      try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
        
        // Note: no-cors mode doesn't allow reading response, so we assume success
        return { success: true };
      } catch (error) {
        console.error('Error sending to Google Sheets:', error);
        return { success: false, error: error.message };
      }
    }
    
    async function saveCoordinate() {
      console.log('Save coordinate clicked');
      
      if (!currentLocation) {
        showToast('Lokasi belum terdeteksi. Tunggu sebentar...');
        return;
      }
      
      if (savedCoordinates.length >= 999) {
        showToast('Maksimal 999 koordinat. Hapus beberapa koordinat terlebih dahulu.');
        return;
      }
      
      const saveBtn = document.getElementById('saveBtn');
      
      // Get form values
      const kecamatanSelect = document.getElementById('kecamatanSelect');
      const kecamatanCustom = document.getElementById('kecamatanCustom');
      const desaSelect = document.getElementById('desaSelect');
      const desaCustom = document.getElementById('desaCustom');
      
      const kecamatan = kecamatanSelect.value === 'lainnya' ? kecamatanCustom.value : kecamatanSelect.value;
      const desa = desaSelect.value === 'lainnya' ? desaCustom.value : desaSelect.value;
      
      // Get layanan pendidikan
      const pendidikanSelect = document.getElementById('pendidikanSelect');
      const pendidikanCustom = document.getElementById('pendidikanCustom');
      const layananPendidikan = pendidikanSelect.value === 'lainnya' ? pendidikanCustom.value : pendidikanSelect.value;
      const namaLayananPendidikan = document.getElementById('namaLayananPendidikan').value.trim();
      
      // Get layanan kesehatan
      const kesehatanSelect = document.getElementById('kesehatanSelect');
      const kesehatanCustom = document.getElementById('kesehatanCustom');
      const layananKesehatan = kesehatanSelect.value === 'lainnya' ? kesehatanCustom.value : kesehatanSelect.value;
      const namaLayananKesehatan = document.getElementById('namaLayananKesehatan').value.trim();
      
      const sinyalTelekomunikasi = document.getElementById('sinyalSelect').value;
      const aksesPln = document.getElementById('plnSelect').value;
      const jangkauanSinyal = document.getElementById('jangkauanSelect').value;
      
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading"></span>Menyimpan...';
      
      const coordinateData = {
        id: Date.now().toString(),
        latitude: currentLocation.latitude,
        longitude: currentLocation.longitude,
        accuracy: currentLocation.accuracy || 0,
        timestamp: new Date().toISOString(),
        note: '',
        kecamatan: kecamatan || '',
        desa: desa || '',
        layanan_pendidikan: layananPendidikan || '',
        nama_layanan_pendidikan: namaLayananPendidikan || '',
        layanan_kesehatan: layananKesehatan || '',
        nama_layanan_kesehatan: namaLayananKesehatan || '',
        sinyal_telekomunikasi: sinyalTelekomunikasi || '',
        akses_pln: aksesPln || '',
        jangkauan_sinyal: jangkauanSinyal || ''
      };
      
      console.log('Data to save:', coordinateData);
      
      // Prepare data for Google Sheets (sesuai urutan yang diminta)
      const googleSheetsData = {
        kecamatan: coordinateData.kecamatan,
        desa: coordinateData.desa,
        layanan_pendidikan: coordinateData.layanan_pendidikan,
        nama_layanan_pendidikan: coordinateData.nama_layanan_pendidikan,
        layanan_kesehatan: coordinateData.layanan_kesehatan,
        nama_layanan_kesehatan: coordinateData.nama_layanan_kesehatan,
        sinyal_telekomunikasi: coordinateData.sinyal_telekomunikasi,
        akses_pln: coordinateData.akses_pln,
        jangkauan_sinyal: coordinateData.jangkauan_sinyal,
        latitude: coordinateData.latitude,
        longitude: coordinateData.longitude,
        timestamp: coordinateData.timestamp
      };
      
      console.log('Google Sheets data:', googleSheetsData);
      
      // Save to local storage (Data SDK) - silent operation
      if (window.dataSdk) {
        console.log('Saving to Data SDK...');
        try {
          const localResult = await window.dataSdk.create(coordinateData);
          console.log('Data SDK result:', localResult);
        } catch (error) {
          console.error('Error saving to Data SDK:', error);
        }
      }
      
      // Send to Google Sheets
      console.log('Sending to Google Sheets...');
      const googleResult = await sendToGoogleSheets(googleSheetsData);
      console.log('Google Sheets result:', googleResult);
      
      if (googleResult.success) {
        showToast('üìç Data berhasil dikirim ke Google Sheets!');
      } else {
        showToast('‚ö†Ô∏è Gagal mengirim ke Google Sheets');
      }
      
      // Reset form
      kecamatanSelect.value = '';
      kecamatanCustom.value = '';
      kecamatanCustom.style.display = 'none';
      desaSelect.value = '';
      desaCustom.value = '';
      desaCustom.style.display = 'none';
      
      // Reset pendidikan
      pendidikanSelect.value = '';
      pendidikanCustom.value = '';
      pendidikanCustom.style.display = 'none';
      document.getElementById('namaLayananPendidikan').value = '';
      
      // Reset kesehatan
      kesehatanSelect.value = '';
      kesehatanCustom.value = '';
      kesehatanCustom.style.display = 'none';
      document.getElementById('namaLayananKesehatan').value = '';
      
      // Unlock both services after reset
      pendidikanSelect.disabled = false;
      pendidikanSelect.style.opacity = '1';
      pendidikanSelect.style.cursor = 'pointer';
      pendidikanCustom.disabled = false;
      pendidikanCustom.style.opacity = '1';
      document.getElementById('namaLayananPendidikan').disabled = false;
      document.getElementById('namaLayananPendidikan').style.opacity = '1';
      
      kesehatanSelect.disabled = false;
      kesehatanSelect.style.opacity = '1';
      kesehatanSelect.style.cursor = 'pointer';
      kesehatanCustom.disabled = false;
      kesehatanCustom.style.opacity = '1';
      document.getElementById('namaLayananKesehatan').disabled = false;
      document.getElementById('namaLayananKesehatan').style.opacity = '1';
      
      document.getElementById('sinyalSelect').value = '';
      document.getElementById('plnSelect').value = '';
      document.getElementById('jangkauanSelect').value = '';
      
      saveBtn.disabled = false;
      saveBtn.innerHTML = `üìç ${window.elementSdk?.config?.save_button_text || defaultConfig.save_button_text}`;
    }
    

    
    // Event listeners
    document.getElementById('saveBtn').addEventListener('click', saveCoordinate);
    

    
    // Handle custom input for kecamatan
    document.getElementById('kecamatanSelect').addEventListener('change', (e) => {
      const customInput = document.getElementById('kecamatanCustom');
      if (e.target.value === 'lainnya') {
        customInput.style.display = 'block';
        customInput.required = true;
      } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
      }
    });
    
    // Handle custom input for desa
    document.getElementById('desaSelect').addEventListener('change', (e) => {
      const customInput = document.getElementById('desaCustom');
      if (e.target.value === 'lainnya') {
        customInput.style.display = 'block';
        customInput.required = true;
      } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
      }
    });
    
    // Handle custom input for layanan pendidikan
    document.getElementById('pendidikanSelect').addEventListener('change', (e) => {
      const customInput = document.getElementById('pendidikanCustom');
      const kesehatanSelect = document.getElementById('kesehatanSelect');
      const kesehatanCustom = document.getElementById('kesehatanCustom');
      const namaKesehatan = document.getElementById('namaLayananKesehatan');
      
      if (e.target.value === 'lainnya') {
        customInput.style.display = 'block';
        customInput.required = true;
      } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
      }
      
      // Lock/unlock layanan kesehatan based on pendidikan selection
      if (e.target.value && e.target.value !== '') {
        // Pendidikan dipilih, kunci kesehatan
        kesehatanSelect.disabled = true;
        kesehatanSelect.style.opacity = '0.5';
        kesehatanSelect.style.cursor = 'not-allowed';
        kesehatanCustom.disabled = true;
        kesehatanCustom.style.opacity = '0.5';
        namaKesehatan.disabled = true;
        namaKesehatan.style.opacity = '0.5';
        
        // Reset nilai kesehatan
        kesehatanSelect.value = '';
        kesehatanCustom.value = '';
        kesehatanCustom.style.display = 'none';
        namaKesehatan.value = '';
      } else {
        // Pendidikan tidak dipilih, buka kunci kesehatan
        kesehatanSelect.disabled = false;
        kesehatanSelect.style.opacity = '1';
        kesehatanSelect.style.cursor = 'pointer';
        kesehatanCustom.disabled = false;
        kesehatanCustom.style.opacity = '1';
        namaKesehatan.disabled = false;
        namaKesehatan.style.opacity = '1';
      }
    });
    
    // Handle custom input for layanan kesehatan
    document.getElementById('kesehatanSelect').addEventListener('change', (e) => {
      const customInput = document.getElementById('kesehatanCustom');
      const pendidikanSelect = document.getElementById('pendidikanSelect');
      const pendidikanCustom = document.getElementById('pendidikanCustom');
      const namaPendidikan = document.getElementById('namaLayananPendidikan');
      
      if (e.target.value === 'lainnya') {
        customInput.style.display = 'block';
        customInput.required = true;
      } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
      }
      
      // Lock/unlock layanan pendidikan based on kesehatan selection
      if (e.target.value && e.target.value !== '') {
        // Kesehatan dipilih, kunci pendidikan
        pendidikanSelect.disabled = true;
        pendidikanSelect.style.opacity = '0.5';
        pendidikanSelect.style.cursor = 'not-allowed';
        pendidikanCustom.disabled = true;
        pendidikanCustom.style.opacity = '0.5';
        namaPendidikan.disabled = true;
        namaPendidikan.style.opacity = '0.5';
        
        // Reset nilai pendidikan
        pendidikanSelect.value = '';
        pendidikanCustom.value = '';
        pendidikanCustom.style.display = 'none';
        namaPendidikan.value = '';
      } else {
        // Kesehatan tidak dipilih, buka kunci pendidikan
        pendidikanSelect.disabled = false;
        pendidikanSelect.style.opacity = '1';
        pendidikanSelect.style.cursor = 'pointer';
        pendidikanCustom.disabled = false;
        pendidikanCustom.style.opacity = '1';
        namaPendidikan.disabled = false;
        namaPendidikan.style.opacity = '1';
      }
    });
    
    async function init() {
      console.log('Initializing app...');
      console.log('Data SDK available:', !!window.dataSdk);
      console.log('Element SDK available:', !!window.elementSdk);
      
      // Wait a bit for SDKs to load
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Initialize Data SDK - silent operation
      if (window.dataSdk) {
        console.log('Initializing Data SDK...');
        try {
          const initResult = await window.dataSdk.init(dataHandler);
          console.log('Data SDK init result:', initResult);
        } catch (error) {
          console.error('Error initializing Data SDK:', error);
        }
      }
      
      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.background_gradient_start || defaultConfig.background_gradient_start,
                set: (value) => {
                  config.background_gradient_start = value;
                  window.elementSdk.setConfig({ background_gradient_start: value });
                }
              },
              {
                get: () => config.background_gradient_end || defaultConfig.background_gradient_end,
                set: (value) => {
                  config.background_gradient_end = value;
                  window.elementSdk.setConfig({ background_gradient_end: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", config.app_title || defaultConfig.app_title],
            ["save_button_text", config.save_button_text || defaultConfig.save_button_text],
            ["empty_message", config.empty_message || defaultConfig.empty_message],
            ["location_title", config.location_title || defaultConfig.location_title]
          ])
        });
      }
      
      // Start location tracking
      startLocationWatch();
    }
    
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99904cbfe5b7d439',t:'MTc2MjIxOTM0MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
