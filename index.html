<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS Coordinate Tracker</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        html {
            height: 100%;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .location-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .coordinate-display {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
        }
        .history-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-blue-50 to-indigo-100">
  <main class="container mx-auto px-4 py-6 max-w-4xl"><!-- Header -->
   <header class="text-center mb-8">
    <h1 id="app-title" class="text-4xl font-bold text-gray-800 mb-2">GPS Coordinate Tracker</h1>
    <p class="text-gray-600">Dapatkan koordinat GPS Anda dengan akurat</p>
   </header><!-- Current Location Card -->
   <div class="location-card mb-8">
    <div class="flex items-center justify-between mb-4">
     <h2 class="text-2xl font-semibold">üìç Lokasi Saat Ini</h2>
     <div id="status-indicator" class="w-3 h-3 bg-gray-400 rounded-full"></div>
    </div>
    <div id="location-display" class="space-y-4">
     <div class="coordinate-display">
      <div class="text-sm opacity-80 mb-1">
       Latitude
      </div>
      <div id="latitude-display" class="text-2xl font-mono">
       -
      </div>
     </div>
     <div class="coordinate-display">
      <div class="text-sm opacity-80 mb-1">
       Longitude
      </div>
      <div id="longitude-display" class="text-2xl font-mono">
       -
      </div>
     </div>
     <div class="coordinate-display">
      <div class="text-sm opacity-80 mb-1">
       Akurasi
      </div>
      <div id="accuracy-display" class="text-lg">
       -
      </div>
     </div>
     <div class="coordinate-display">
      <div class="text-sm opacity-80 mb-1">
       Waktu
      </div>
      <div id="timestamp-display" class="text-lg">
       -
      </div>
     </div>
    </div>
    <div class="flex gap-4 mt-6"><button id="get-location-btn" class="flex-1 bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors"> üéØ <span id="tracking-button-text">Dapatkan Lokasi Saya</span> </button> <button id="save-location-btn" class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled> üíæ <span id="save-button-text">Simpan Lokasi</span> </button>
    </div>
    <div id="maps-link" class="mt-4 hidden"><a id="google-maps-link" href="#" target="_blank" rel="noopener noreferrer" class="inline-block bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"> üó∫Ô∏è Buka di Google Maps </a>
    </div>
   </div><!-- Location History -->
   <div class="bg-white rounded-2xl p-6 shadow-lg">
    <div class="flex items-center justify-between mb-6">
     <h2 class="text-2xl font-bold text-gray-800">üìã Riwayat Lokasi</h2>
     <div id="location-count" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold">
      0 lokasi tersimpan
     </div>
    </div>
    <div id="history-list" class="space-y-4">
     <div class="text-center text-gray-500 py-8">
      Belum ada lokasi yang tersimpan. Klik "Dapatkan Lokasi Saya" untuk memulai!
     </div>
    </div>
   </div><!-- Loading Overlay -->
   <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 text-center">
     <div class="animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4"></div>
     <p class="text-gray-700">Mendapatkan lokasi Anda...</p>
    </div>
   </div>
  </main>
  <script>
        // Configuration
        const defaultConfig = {
            app_title: "GPS Coordinate Tracker",
            tracking_button_text: "Dapatkan Lokasi Saya",
            save_button_text: "Simpan Lokasi"
        };

        // Global state
        let currentLocation = null;
        let locationHistory = [];
        let isTracking = false;

        // DOM elements
        const elements = {
            getLocationBtn: document.getElementById('get-location-btn'),
            saveLocationBtn: document.getElementById('save-location-btn'),
            latitudeDisplay: document.getElementById('latitude-display'),
            longitudeDisplay: document.getElementById('longitude-display'),
            accuracyDisplay: document.getElementById('accuracy-display'),
            timestampDisplay: document.getElementById('timestamp-display'),
            statusIndicator: document.getElementById('status-indicator'),
            mapsLink: document.getElementById('maps-link'),
            googleMapsLink: document.getElementById('google-maps-link'),
            historyList: document.getElementById('history-list'),
            locationCount: document.getElementById('location-count'),
            loadingOverlay: document.getElementById('loading-overlay')
        };

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                locationHistory = data;
                updateHistoryDisplay();
                updateLocationCount();
            }
        };

        // Initialize Data SDK
        async function initializeDataSDK() {
            if (window.dataSdk) {
                try {
                    const result = await window.dataSdk.init(dataHandler);
                    if (!result.isOk) {
                        console.error('Failed to initialize Data SDK:', result.error);
                        showError('Gagal menginisialisasi sistem penyimpanan');
                    } else {
                        console.log('Data SDK initialized successfully');
                    }
                } catch (error) {
                    console.error('Data SDK initialization error:', error);
                    showError('Error saat menginisialisasi sistem penyimpanan');
                }
            } else {
                console.error('Data SDK not available');
                showError('Sistem penyimpanan tidak tersedia');
            }
        }

        // Get current location
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showError('Geolocation tidak didukung oleh browser Anda');
                return;
            }

            isTracking = true;
            elements.loadingOverlay.classList.remove('hidden');
            elements.getLocationBtn.disabled = true;
            elements.statusIndicator.className = 'w-3 h-3 bg-yellow-400 rounded-full pulse';

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    const timestamp = new Date().toISOString();
                    
                    currentLocation = {
                        latitude,
                        longitude,
                        accuracy,
                        timestamp
                    };

                    displayCurrentLocation(currentLocation);
                    elements.loadingOverlay.classList.add('hidden');
                    elements.getLocationBtn.disabled = false;
                    elements.saveLocationBtn.disabled = false;
                    elements.statusIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                    isTracking = false;
                },
                (error) => {
                    let errorMessage = 'Gagal mendapatkan lokasi';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Akses lokasi ditolak. Silakan izinkan akses lokasi di browser Anda.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Informasi lokasi tidak tersedia.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Waktu habis saat mencari lokasi.';
                            break;
                    }
                    showError(errorMessage);
                    elements.loadingOverlay.classList.add('hidden');
                    elements.getLocationBtn.disabled = false;
                    elements.statusIndicator.className = 'w-3 h-3 bg-red-400 rounded-full';
                    isTracking = false;
                },
                options
            );
        }

        // Display current location
        function displayCurrentLocation(location) {
            elements.latitudeDisplay.textContent = location.latitude.toFixed(6);
            elements.longitudeDisplay.textContent = location.longitude.toFixed(6);
            elements.accuracyDisplay.textContent = `¬±${Math.round(location.accuracy)} meter`;
            elements.timestampDisplay.textContent = new Date(location.timestamp).toLocaleString('id-ID');

            // Show Google Maps link
            const mapsUrl = `https://www.google.com/maps?q=${location.latitude},${location.longitude}`;
            elements.googleMapsLink.href = mapsUrl;
            elements.mapsLink.classList.remove('hidden');
        }

        // Save location to Data SDK
        async function saveLocation() {
            if (!currentLocation) {
                showError('Tidak ada lokasi untuk disimpan. Dapatkan lokasi terlebih dahulu.');
                return;
            }

            if (!window.dataSdk) {
                showError('Sistem penyimpanan tidak tersedia.');
                return;
            }

            // Check if we're at the limit
            if (locationHistory.length >= 999) {
                showError('Batas maksimum 999 lokasi tercapai. Hapus beberapa lokasi terlebih dahulu.');
                return;
            }

            elements.saveLocationBtn.disabled = true;
            elements.saveLocationBtn.innerHTML = '‚è≥ Menyimpan...';

            const locationData = {
                id: Date.now().toString(),
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude,
                accuracy: currentLocation.accuracy,
                timestamp: currentLocation.timestamp,
                address: `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`
            };

            try {
                const result = await window.dataSdk.create(locationData);
                
                if (result.isOk) {
                    showSuccess('Lokasi berhasil disimpan!');
                    // Reset current location after saving
                    currentLocation = null;
                    elements.saveLocationBtn.disabled = true;
                } else {
                    console.error('Data SDK error:', result.error);
                    showError(`Gagal menyimpan lokasi: ${result.error?.message || 'Error tidak diketahui'}`);
                }
            } catch (error) {
                console.error('Save location error:', error);
                showError('Terjadi kesalahan saat menyimpan lokasi. Silakan coba lagi.');
            }

            elements.saveLocationBtn.disabled = false;
            elements.saveLocationBtn.innerHTML = `üíæ <span id="save-button-text">${window.elementSdk?.config?.save_button_text || defaultConfig.save_button_text}</span>`;
        }

        // Update history display
        function updateHistoryDisplay() {
            if (locationHistory.length === 0) {
                elements.historyList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        Belum ada lokasi yang tersimpan. Klik "Dapatkan Lokasi Saya" untuk memulai!
                    </div>
                `;
                return;
            }

            const sortedHistory = [...locationHistory].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            elements.historyList.innerHTML = sortedHistory.map(location => `
                <div class="history-item">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800 mb-1">
                                üìç ${new Date(location.timestamp).toLocaleString('id-ID')}
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                <div>Lat: <span class="font-mono">${location.latitude.toFixed(6)}</span></div>
                                <div>Lng: <span class="font-mono">${location.longitude.toFixed(6)}</span></div>
                                <div>Akurasi: ¬±${Math.round(location.accuracy)} meter</div>
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <a href="https://www.google.com/maps?q=${location.latitude},${location.longitude}" 
                               target="_blank" rel="noopener noreferrer"
                               class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors">
                                üó∫Ô∏è Maps
                            </a>
                            <button onclick="deleteLocation('${location.__backendId}')" 
                                    class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors">
                                üóëÔ∏è Hapus
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Delete location
        async function deleteLocation(backendId) {
            const locationToDelete = locationHistory.find(loc => loc.__backendId === backendId);
            if (!locationToDelete || !window.dataSdk) return;

            const result = await window.dataSdk.delete(locationToDelete);
            if (result.isOk) {
                showSuccess('Lokasi berhasil dihapus!');
            } else {
                showError('Gagal menghapus lokasi. Silakan coba lagi.');
            }
        }

        // Update location count
        function updateLocationCount() {
            const count = locationHistory.length;
            elements.locationCount.textContent = `${count} lokasi tersimpan`;
        }

        // Show success message
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Show error message
        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Element SDK Configuration
        async function onConfigChange(config) {
            document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
            document.getElementById('tracking-button-text').textContent = config.tracking_button_text || defaultConfig.tracking_button_text;
            document.getElementById('save-button-text').textContent = config.save_button_text || defaultConfig.save_button_text;
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ['app_title', config.app_title || defaultConfig.app_title],
                ['tracking_button_text', config.tracking_button_text || defaultConfig.tracking_button_text],
                ['save_button_text', config.save_button_text || defaultConfig.save_button_text]
            ]);
        }

        // Initialize Element SDK
        async function initializeElementSDK() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }
        }

        // Event listeners
        elements.getLocationBtn.addEventListener('click', getCurrentLocation);
        elements.saveLocationBtn.addEventListener('click', saveLocation);

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('App initializing...');
            console.log('Data SDK available:', !!window.dataSdk);
            console.log('Element SDK available:', !!window.elementSdk);
            
            await initializeDataSDK();
            await initializeElementSDK();
            
            console.log('App initialization complete');
        });

        // Make deleteLocation available globally
        window.deleteLocation = deleteLocation;
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'998a868cc204fd93',t:'MTc2MjE1ODc5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
